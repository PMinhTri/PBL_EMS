import { Injectable } from '@nestjs/common';
import { PrismaService } from 'src/prisma/prisma.service';
import { createUserDto, userInformationDto } from './user.dto';
import {
  ServiceFailure,
  ServiceResponse,
  ServiceResponseStatus,
} from 'src/serviceResponse';
import { UserFailure } from 'src/enumTypes/failure.enum';
import { MailService } from 'src/mail/mail.service';
import { autoGeneratedPassword, hashPassword } from 'src/utils/password';
import { UserInformation } from './user.type';
import { User } from '@prisma/client';

@Injectable()
export class UserService {
  constructor(
    private prisma: PrismaService,
    private mailService: MailService,
  ) {}

  public async createUser(
    dto: createUserDto,
  ): Promise<
    ServiceResponse<
      { user: createUserDto; password: string },
      ServiceFailure<UserFailure>
    >
  > {
    const existingUser = await this.prisma.user.findUnique({
      where: {
        email: dto.email,
      },
    });

    if (existingUser) {
      return {
        status: ServiceResponseStatus.Failed,
        failure: {
          reason: UserFailure.USER_ALREADY_EXISTS,
        },
      };
    }
    const generatedPassword = autoGeneratedPassword();
    const hashedPassword = await hashPassword(generatedPassword);

    try {
      await this.mailService.receiveDefaultPassword(
        dto.email,
        generatedPassword,
      );
    } catch (err) {
      return {
        status: ServiceResponseStatus.Failed,
        failure: {
          reason: err,
        },
      };
    }

    const user = await this.prisma.user.create({
      data: {
        email: dto.email,
        fullName: dto.fullName,
        password: hashedPassword,
        gender: dto.gender,
        status: dto.status,
        roleId: dto.roleId,
      },

      select: {
        id: true,
        email: true,
        fullName: true,
        password: true,
        gender: true,
        status: true,
        roleId: true,
      },
    });

    return {
      status: ServiceResponseStatus.Success,
      result: { user, password: generatedPassword },
    };
  }

  public async getAllEmails(): Promise<string[]> {
    const emails = await this.prisma.user.findMany({
      select: {
        email: true,
      },
    });

    return emails.map((email) => email.email);
  }

  public async updatePersonalInformation(
    email: string,
    dto: userInformationDto,
  ): Promise<ServiceResponse<userInformationDto, ServiceFailure<UserFailure>>> {
    const user = await this.prisma.user.findFirst({
      where: {
        email: email,
      },
    });

    if (!user) {
      return {
        status: ServiceResponseStatus.Failed,
        failure: {
          reason: UserFailure.USER_NOT_FOUND,
        },
      };
    }

    await this.prisma.user.update({
      where: {
        id: user.id,
      },
      data: {
        fullName: dto.fullName,
        firstName: dto.firstName,
        lastName: dto.lastName,
        gender: dto.gender,
        dateOfBirth: new Date(dto.dateOfBirth),
        phoneNumber: dto.phoneNumber,
        citizenId: dto.citizenId,
        address: dto.address,
        city: dto.city,
        nationality: dto.nationality,
        avatar: dto.avatar,
      },
    });

    return {
      status: ServiceResponseStatus.Success,
    };
  }

  public async getAllUsers(): Promise<
    ServiceResponse<userInformationDto[], ServiceFailure<UserFailure>>
  > {
    const userInformationDto = await this.prisma.user.findMany({
      select: {
        id: true,
        email: true,
        fullName: true,
        firstName: true,
        lastName: true,
        gender: true,
        dateOfBirth: true,
        phoneNumber: true,
        citizenId: true,
        address: true,
        city: true,
        nationality: true,
        avatar: true,
        status: true,
        role: {
          select: {
            name: true,
          },
        },
      },
    });

    return {
      status: ServiceResponseStatus.Success,
      result: userInformationDto,
    };
  }

  public async getById(
    id: number,
  ): Promise<ServiceResponse<UserInformation, ServiceFailure<UserFailure>>> {
    const user = await this.prisma.user.findUnique({
      where: {
        id: id,
      },
      select: {
        id: true,
        email: true,
        fullName: true,
        firstName: true,
        lastName: true,
        gender: true,
        dateOfBirth: true,
        phoneNumber: true,
        address: true,
        citizenId: true,
        city: true,
        nationality: true,
        avatar: true,
        status: true,
        role: {
          select: {
            name: true,
          },
        },
      },
    });

    if (!user) {
      return {
        status: ServiceResponseStatus.Failed,
        failure: {
          reason: UserFailure.USER_NOT_FOUND,
        },
      };
    }

    return {
      status: ServiceResponseStatus.Success,
      result: user,
    };
  }

  public async deleteById(
    id: number,
  ): Promise<ServiceResponse<User, ServiceFailure<UserFailure>>> {
    const user = await this.prisma.user.findUnique({
      where: {
        id: id,
      },
    });

    if (!user) {
      return {
        status: ServiceResponseStatus.Failed,
        failure: {
          reason: UserFailure.USER_NOT_FOUND,
        },
      };
    }

    await this.prisma.user.delete({
      where: {
        id: id,
      },
    });

    return {
      status: ServiceResponseStatus.Success,
      result: user,
    };
  }
}
